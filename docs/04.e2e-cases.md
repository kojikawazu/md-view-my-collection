# E2Eテスト仕様（厳密版）

## 前提データ作成方針
- テスト実行前に初期データを用意できる仕組みを持つ（fixture/seedなど）。
- ログイン済/未ログインの状態を切り替えられる手段を用意する。
- 「レポート0件」ケースはデータ初期化で再現する。

## 実行方法
- 初回のみ: `cd front && npx playwright install`
- `cd front && npm run test:e2e`
- UIモード: `cd front && npm run test:e2e:ui`
- レポート表示: `cd front && npm run test:e2e:report`
- 既存サーバーを使う場合: `PLAYWRIGHT_BASE_URL=http://127.0.0.1:3000 npm run test:e2e`

## CI（GitHub Actions）
- `front/playwright.config.ts` により、CIでは `NEXT_PUBLIC_AUTH_MODE=local` / `NEXT_PUBLIC_DATA_MODE=local` で起動する。
- Supabaseクライアント初期化のため、CIでは `NEXT_PUBLIC_SUPABASE_URL` / `NEXT_PUBLIC_SUPABASE_ANON_KEY` をダミー値で渡す。

## テストデータ注入
- 各テストで `localStorage` の `espresso_reports` / `espresso_user` を初期化して前提状態を作成する。
- E2E実行時は `NEXT_PUBLIC_AUTH_MODE=local` を使い、Authをローカルモードで動作させる。
- E2E実行時は `NEXT_PUBLIC_DATA_MODE=local` を使い、Reportデータをローカルモードで動作させる。

## 画面×観点マトリクス（前提/手順/期待）

### 一覧（/）
- 表示
  - 前提: レポートが1件以上ある
  - 手順: `/` を開く
  - 期待: カードにカテゴリ/日付/タイトル/要約/著者が表示
- フィルタ（カテゴリ）
  - 前提: 複数カテゴリのレポートが存在
  - 手順: サイドバーのカテゴリをクリック
  - 期待: 一覧が該当カテゴリのみ表示、再クリックで解除
- フィルタ（タグ）
  - 前提: 複数タグのレポートが存在
  - 手順: サイドバーのタグをクリック
  - 期待: 一覧が該当タグのみ表示、再クリックで解除
- 空表示
  - 前提: レポート0件
  - 手順: `/` を開く
  - 期待: “No reports found.” が表示
- 遷移
  - 前提: レポートが存在
  - 手順: カードのタイトル or “Read Report” をクリック
  - 期待: `/report/:id` に遷移

### 詳細（/report/:id）
- 表示
  - 前提: 該当IDが存在
  - 手順: `/report/:id` を開く
  - 期待: タイトル/著者/日付/カテゴリ/本文/タグが表示
- 編集導線
  - 前提: ログイン済
  - 手順: 詳細を開く
  - 期待: 「編集」「削除」ボタンが表示
- 未ログイン導線非表示
  - 前提: 未ログイン
  - 手順: 詳細を開く
  - 期待: 編集/削除ボタンは表示されない
- 404相当
  - 前提: 存在しないID
  - 手順: `/report/unknown`
  - 期待: “Report Not Found”

### 新規作成（/report/new）
- アクセス制御
  - 前提: 未ログイン
  - 手順: `/report/new` 直アクセス
  - 期待: `/login` にリダイレクト
- 必須入力
  - 前提: ログイン済
  - 手順: タイトル/本文/カテゴリ/著者/タグ未入力で送信
  - 期待: 送信できない/バリデーション表示
- 確認モーダル
  - 前提: ログイン済
  - 手順: 必須入力 → 送信
  - 期待: 確認モーダルが表示
- 成功
  - 前提: ログイン済
  - 手順: 確認 → 投稿
  - 期待: 一覧先頭に追加される

### 編集（/report/:id/edit）
- アクセス制御
  - 前提: 未ログイン
  - 手順: `/report/:id/edit` 直アクセス
  - 期待: `/login` にリダイレクト
- 既存データ反映
  - 前提: ログイン済、既存レポートあり
  - 手順: 編集画面を開く
  - 期待: 既存値がフォームに入っている
- 確認モーダル
  - 前提: ログイン済
  - 手順: 更新 → 確認
  - 期待: モーダルが表示
- 成功
  - 前提: ログイン済
  - 手順: 更新確定
  - 期待: 詳細に反映される

### ログイン（/login）
- 入力必須
  - 前提: 未ログイン
  - 手順: 空入力で送信
  - 期待: 認証不可/遷移なし
- 成功
  - 前提: 未ログイン
  - 手順: ユーザー名/パスワード入力 → 送信
  - 期待: `/` に遷移、ヘッダーにユーザー表示
- 失敗（許可メール不一致）
  - 前提: 未ログイン
  - 手順: 許可外メールでログイン
  - 期待: エラーメッセージ表示、ログイン不可

### 削除/ログアウト
- 削除確認
  - 前提: ログイン済
  - 手順: 詳細で削除 → モーダル
  - 期待: 取消で削除されない / 確定で削除
- ログアウト
  - 前提: ログイン済
  - 手順: Logout
  - 期待: `/login` に遷移、管理導線非表示

## 詳細テストケース（ID/前提/手順/期待）

- TC-001 正常: 一覧表示
  - 前提: レポート1件以上
  - 手順: `/` を開く
  - 期待: カードにカテゴリ/日付/タイトル/要約/著者が表示

- TC-002 正常: 一覧→詳細遷移
  - 前提: レポートが存在
  - 手順: タイトル or “Read Report” クリック
  - 期待: `/report/:id` へ遷移

- TC-003 異常: 一覧0件
  - 前提: レポート0件
  - 手順: `/` を開く
  - 期待: “No reports found.” 表示

- TC-003-2 正常: カテゴリフィルタ
  - 前提: 複数カテゴリのレポートが存在
  - 手順: サイドバーのカテゴリをクリック
  - 期待: 該当カテゴリのみ表示、再クリックで解除

- TC-003-3 正常: タグフィルタ
  - 前提: 複数タグのレポートが存在
  - 手順: サイドバーのタグをクリック
  - 期待: 該当タグのみ表示、再クリックで解除

- TC-004 正常: 詳細表示
  - 前提: 該当IDが存在
  - 手順: `/report/:id` を開く
  - 期待: タイトル/著者/日付/本文/タグが表示

- TC-005 異常: 詳細ID不正
  - 前提: 存在しないID
  - 手順: `/report/unknown`
  - 期待: “Report Not Found”

- TC-006 準正常: 未ログインで編集導線なし
  - 前提: 未ログイン、ID存在
  - 手順: `/report/:id`
  - 期待: 編集/削除ボタン非表示

- TC-007 正常: ログイン成功
  - 前提: 未ログイン
  - 手順: `/login` → ユーザー名/パスワード入力 → 送信
  - 期待: `/` に遷移、ヘッダーにユーザー/Logout表示

- TC-008 異常: ログイン空入力
  - 前提: 未ログイン
  - 手順: 空入力で送信
  - 期待: 認証不可/遷移なし

- TC-008-2 異常: 許可メール不一致
  - 前提: 未ログイン
  - 手順: 許可外メールでログイン
  - 期待: エラーメッセージ表示、ログイン不可

- TC-009 異常: 未ログインで新規作成直アクセス
  - 前提: 未ログイン
  - 手順: `/report/new`
  - 期待: `/login` にリダイレクト

- TC-010 異常: 未ログインで編集直アクセス
  - 前提: 未ログイン
  - 手順: `/report/:id/edit`
  - 期待: `/login` にリダイレクト

- TC-011 正常: 新規作成→確認→投稿
  - 前提: ログイン済
  - 手順: 必須項目入力 → 送信 → 確認
  - 期待: 一覧先頭に追加

- TC-012 異常: 新規作成必須未入力
  - 前提: ログイン済
  - 手順: タイトル/要約/本文未入力で送信
  - 期待: 送信不可/エラーメッセージ

- TC-013 異常: タグ未入力
  - 前提: ログイン済
  - 手順: タグ未入力で投稿
  - 期待: 送信不可/バリデーション表示

- TC-014 準正常: タグ正規化
  - 前提: ログイン済
  - 手順: `a, b, #c` を入力し投稿
  - 期待: `#a #b #c` に正規化

- TC-015 正常: 編集初期値反映
  - 前提: ログイン済、既存レポート
  - 手順: `/report/:id/edit`
  - 期待: フォームに既存値が入る

- TC-016 正常: 編集→確認→反映
  - 前提: ログイン済
  - 手順: 内容編集 → 送信 → 確認
  - 期待: 詳細に反映

- TC-017 準正常: 編集で本文のみ変更
  - 前提: ログイン済
  - 手順: 本文のみ変更して保存
  - 期待: 他項目は保持

- TC-018 正常: 削除キャンセル
  - 前提: ログイン済
  - 手順: 削除 → モーダルでキャンセル
  - 期待: 削除されない

- TC-019 正常: 削除確定
  - 前提: ログイン済
  - 手順: 削除 → モーダルで確定
  - 期待: 一覧から消える

- TC-020 正常: ログアウト
  - 前提: ログイン済
  - 手順: Logout
  - 期待: `/login` に遷移、管理導線非表示
