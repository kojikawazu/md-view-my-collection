# 要件定義（ドラフト）

## 参照ドキュメント
- `docs/02.ui-layout.md`（最新UIレイアウト要求）
- `docs/04.e2e-cases.md`（E2Eテスト仕様・詳細ケース）

## 機能要件（ユーザーストーリー）
- 一覧: レポートの概要・著者・日付・カテゴリを閲覧し、詳細へ遷移できる。
- 一覧: カテゴリ/タグでレポートをフィルタできる（再クリックで解除、一覧復帰時はリセット）。
- 詳細: Markdown本文とタグを閲覧できる。管理者は編集/削除できる（削除は確認モーダル必須）。
- Markdown Style Lab: 管理者がMarkdown表示デザインを検証できる（`/report/markdown-lab`）。
- 新規作成: 管理者がレポートを作成し、投稿前に確認できる。
- 編集: 管理者がレポートを更新し、保存前に確認できる。
- 認証: 管理者がログイン/ログアウトできる。

## データ要件
- Report: `id`, `title`, `summary`, `content`, `category`, `author`, `publishDate`, `tags`
- User: Supabase Auth を利用（アプリ側のUserテーブルは持たない）
- 必須項目: title/content/category/author/tags
- タグ入力はカンマ区切り → `#` 付き配列に正規化
- カテゴリは固定リスト（Development / AI / Cloud / Linux / Container / Application / Program / Hobby）。
- サイドバーに表示するタグは `ReportTag` テーブルを参照し、一覧フィルタに使用する。
- DB設計は現状のままでOK。Supabase設定は別プロジェクトで実施する。
- Prismaは既存テーブルを `prisma db pull` で取得し、新規テーブル設計は `schema.prisma` に反映（マイグレーションは行わない）。
- 環境変数: `DATABASE_URL`（Supabase Postgres 接続）
  - `prisma.config.ts` で `DATABASE_URL` を参照し、`schema.prisma` には接続文字列を置かない。
- E2Eは `NEXT_PUBLIC_AUTH_MODE=local` / `NEXT_PUBLIC_DATA_MODE=local` を使用してローカルデータを利用する。

## 権限/アクセス
- 未ログイン: 閲覧のみ
- ログイン: 投稿/編集/削除が可能
  - Markdown Style Lab（`/report/markdown-lab`）もログイン時のみアクセス可能
  - RLS方針: Reportは公開閲覧、認証ユーザーのみ書き込み可能
- 管理者メールは環境変数 `ADMIN_EMAIL` の一致のみ許可（複数指定はカンマ区切り）。

## 非機能要件
- デプロイ: 本番運用はVercelで実施（デプロイ必須）。
- CI/CD: 自動デプロイのみ（Vercel連携を前提）。`main` ブランチのみ、本番デプロイ。プレビューは不要。
- CI: GitHub ActionsでE2E（Playwright）を自動実行する。
- テスト: E2Eテストでカバーし、ユニットテストは行わない。
- E2Eテストは正常/準正常/異常をすべて必須とする。
- 監視/ログ: ユニットテスト無しでも不具合を早期発見できるログ設計を意識する。
- セキュリティ: Markdown表示はサニタイズ必須。
- セキュリティ: Supabase RLSは「公開閲覧 + 認証ユーザーのみ書き込み」を採用する。
- ログ出力: 開発/本番とも `console` のみ。本番はセキュリティ配慮（個人情報/機密を出力しない）。

## 技術スタック
- TypeScript + Next.js (App Router) + React + TailwindCSS
- Markdown: react-markdown + remark-gfm + rehype-sanitize（画像/外部リンクを許可）
- 認証: Supabase Auth（本番接続）

## セキュリティ詳細（Markdown）
- Markdown表示は `rehype-sanitize` のデフォルトスキーマでサニタイズする。
- `a`/`img` の許可属性は現状カスタム設定を行っていない（必要ならスキーマ拡張で対応する）。

## デプロイ設定（確定）
- 対象ディレクトリ: `front/` のみ（`base/` は対象外）。
- ブランチ: `main` のみ自動デプロイ。
- プレビュー: 不要。
- 環境変数: Supabase接続用の `NEXT_PUBLIC_SUPABASE_URL` / `NEXT_PUBLIC_SUPABASE_ANON_KEY` を設定。
- 環境変数: OAuthリダイレクト用の `NEXT_PUBLIC_SITE_URL` を必要に応じて設定。
- ビルド: Next.js標準（`npm install` → `npm run build`）。

## コーディング規約（案）
- 2スペースインデント、セミコロンあり（既存コード準拠）。
- ReactコンポーネントはPascalCase、ユーティリティはcamelCase。
- `base/` は読み取り専用とし、実装は `front/` に `base/` をコピーして行う。
- 画面は `front/src/app/`（App Router）、共通UIは `front/src/components/` に配置。
- Tailwindクラスは既存の並びに合わせて読みやすさ優先で記述。
- 再利用性を意識して、適切にコンポーネント分割する。
- `base/` から `front/` へのコピーは開発開始時の1回のみ。以後は `front/` のみを更新する。
- コピー作業は開発開始担当が実施し、`base/` 変更は追随しない前提。
- 開発開始時は必ずブランチを切って作業する。

## ログ仕様（最低限）
- 重要操作（ログイン/ログアウト/投稿/編集/削除）を `console.info` で記録。
- 例外は `console.error` で記録し、IDや操作種別を含める。
